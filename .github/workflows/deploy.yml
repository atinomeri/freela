name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    environment:
      name: production
    permissions:
      contents: read
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PORT: ${{ secrets.VPS_SSH_PORT }}
      VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
      SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
      VPS_HOST_KEY: ${{ secrets.VPS_HOST_KEY }}
      DEPLOY_BRANCH: main
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
      HEALTHCHECK_URL: ${{ secrets.DEPLOY_HEALTHCHECK_URL }}
    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          for v in VPS_HOST VPS_USER VPS_PORT VPS_APP_DIR SSH_PRIVATE_KEY; do
            if [ -z "${!v}" ]; then
              echo "::error::Missing required secret: $v"
              exit 1
            fi
          done

      - name: Configure SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          if [ -n "$VPS_HOST_KEY" ]; then
            printf '%s\n' "$VPS_HOST_KEY" > ~/.ssh/known_hosts
          else
            echo "::warning::VPS_HOST_KEY is not set; using ssh-keyscan fallback."
            ssh-keyscan -p "$VPS_PORT" -H "$VPS_HOST" > ~/.ssh/known_hosts
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy on server
        run: |
          set -euo pipefail
          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" \
            "APP_DIR='$VPS_APP_DIR' BRANCH='$DEPLOY_BRANCH' EXPECTED_SHA='$DEPLOY_SHA' bash -s" <<'EOF'
          set -euo pipefail
          cd "$APP_DIR"
          echo "Using repo at: $(pwd)"
          echo "Origin: $(git remote get-url origin)"
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"
          git pull --ff-only origin "$BRANCH"
          CURRENT_SHA="$(git rev-parse HEAD)"
          echo "Checked out SHA: $CURRENT_SHA"
          if [ -n "${EXPECTED_SHA:-}" ] && [ "$CURRENT_SHA" != "$EXPECTED_SHA" ]; then
            echo "::error::Deployed SHA mismatch. Expected $EXPECTED_SHA, got $CURRENT_SHA"
            exit 1
          fi
          cd deploy
          docker compose -f docker-compose.prod.yml up -d --build
          docker compose -f docker-compose.prod.yml exec -T app npm run prisma:migrate:deploy
          EOF

      - name: Health check
        if: env.HEALTHCHECK_URL != ''
        run: |
          set -euo pipefail
          curl --fail --show-error --silent "$HEALTHCHECK_URL" > /dev/null
